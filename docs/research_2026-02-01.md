# Research: Command Centre & Agents Analysis

**Date**: 2026-02-01

## 1. Executive Summary
The Command Centre (`app/command-centre/page.js`) is the central UI hub, interacting with a backend "Agent Router" (`app/api/agent/route.js`). The system uses a specialized agent architecture defined in YAML files (`_bmad/**/*.agent.yaml`).
- **Interaction**: The frontend sends context (financials, candidates, projects) to the API.
- **Routing**: `route.js` loads agent definitions (Personas) and uses `GoogleGenerativeAI` to process requests.
- **Data Flow**: One-way mostly. Frontend builds a "context" object -> API processes it -> API returns text response + "Signal Updates".
- **Gaps**: Agents rely on static YAML definitions and "injected" context strings. They don't "read" the UI components directly; they read the *data* that feeds those components.
- **Jarvis**: Existing definition found in `_bmad-output/bmb-creations/stellar-jarvis/stellar-jarvis.agent.yaml` but is NOT currently hooked up in `route.js`.

## 2. Technical Context

### A. The Agent Router (`app/api/agent/route.js`)
- **File**: `app/api/agent/route.js`
- **Logic**:
    - Defines `PERSONAS` object mapping IDs (`gm`, `scout`, `sales`) to their YAML definitions.
    - **Critical Missing Link**: `jarvis` is missing from the `PERSONAS` map.
    - Uses `runSubAgent` to execute delegated tasks.
    - Hardcodes `FALLBACK_SCOUT` if file missing.
    - **Context Construction**: Manually builds `contextSummary` string from the JSON payload.

### B. The Frontend (`app/command-centre/page.js`)
- **File**: `app/command-centre/page.js`
- **Context Builder**:
    - `buildContext` memoizes critical data: `financials`, `candidates` (sanitized), `clients`, `projects`.
    - Sends this entire object to `api/agent`.
- **Agents Registry**:
    - `AGENTS` array defines the sidebar: `gm`, `scout`, `sales`, `candidate`, `accountant`.
    - **Jarvis Missing**: Jarvis is not in the sidebar list.

### C. The Logic Layer (`services/`)
- **Files**: `construction-logic.js`, `growth-logic.js`, `logic-hub.js`.
- **Functionality**:
    - `construction-logic.js`: Defines phases, roles, compliance, and trade matrices.
    - `growth-logic.js`: "Wolf of Wall Street" logic (Cold calls, reactivation scores).
    - `logic-hub.js`: Central "Router" for tool execution (`runProtocol`). It handles `COMMISSION_AUDIT`, `GOLDEN_HOUR`, `TENDER_INTEL`.
- **Agent Usage**: Agents (via `route.js`) call `logic-hub.js` tools to get "Hard Data".

### D. The Agents (`_bmad/**/*.agent.yaml`)
- **Location**: Scattered. `_bmad-output/bmb-creations/` seems to be the source of truth for generated agents, while `_bmad/custom/stellar-board/agents/` holds others.
- **Jarvis Definition**: exists in `_bmad-output/bmb-creations/stellar-jarvis/stellar-jarvis.agent.yaml`.
    - Has "Sidecar" enabled.
    - Defines specific triggers: `#desk-pulse`, `#crisis-interceptor`, `#rainmaker`.

## 3. Findings & Analysis

1.  **"Reading" the Widgets**: Agents do *not* read the visual widgets. They read the *underlying data* (`context/data-context.js`) passed via the API payload. The "Context Builder" in `command-centre/page.js` is the bridge. To make Jarvis "see" the widgets, we need to ensure `buildContext` includes the specific metrics those widgets display (e.g., `relationship-decay` stats).
2.  **Jarvis is Disconnected**:
    - Not in `AGENTS` list in Command Centre.
    - Not in `PERSONAS` list in `route.js`.
    - He exists as a YAML definition only.
3.  **Data Flow Limitations**:
    - The API `POST` is heavy. It sends the *entire* candidate list every message. For large datasets, this will hit token limits.
    - Agents "hallucinate" interactions with widgets unless the backend tool (`logic-hub.js`) explicitly returns that widget's data structure.

## 4. Technical Constraints
- **Token Limits**: Sending full candidate lists in every API call is unsustainable.
- **Stateless API**: `route.js` is serverless; it forgets context between calls unless passed back (frontend handles history).
- **Hardcoded Personas**: `route.js` requires manual updates to add new agents.

## 5. Architecture Documentation
- **Pattern**: `Frontend Context -> API -> LLM (with System Prompt + Tool Data) -> Response`.
- **Tools**: `services/lib/tools.js` and `services/logic-hub.js` act as the "Hands" of the agents.
