# Transition DataContext to Supabase Implementation Plan

## Overview
This plan transitions the `DataContext` from syncing core entities (Candidates, Projects, Clients) from Google Sheets to querying Supabase via Drizzle ORM. This eliminates the "Data Schism" and ensures the UI and Agents share a single source of truth.

## Current State Analysis
- **Context (`context/data-context.js`)**: Syncs from `/api/sync` (Sheets). Contains complex enrichment logic (`enrichCandidateData`, etc.) to compensate for flat sheet structure.
- **Schema (`lib/db/schema.ts`)**: Missing critical fields found in Sheets (Pay Rate, Visa Expiry, etc.).
- **API (`app/api/sync`)**: Strictly for Google Sheets.

## Implementation Approach
The strategy is "Schema-First." We will update the Supabase schema to accommodate all core fields, then implement new API routes that return structured results, and finally switch the `DataContext` to consume these endpoints.

## Phase 1: Database Schema Expansion
### Overview
Add missing fields to `lib/db/schema.ts` to ensure data parity with Google Sheets.

### Changes Required:
#### 1. `lib/db/schema.ts`
**Changes**: 
- Update `candidates` table: Add `payRate` (integer), `guaranteedHours` (integer), `residency` (text), `visaExpiry` (timestamp), and `siteSafeExpiry` (timestamp).
- Update `projects` table: Add `siteManagerPhone` (text), `clientDemands` (jsonb).
- Update `clients` table: Add `accountManager` (text), `notes` (jsonb).

```typescript
// lib/db/schema.ts additions
// In candidates table:
payRate: integer('pay_rate'),
guaranteedHours: integer('guaranteed_hours'),
residency: text('residency'),
visaExpiry: timestamp('visa_expiry', { withTimezone: true }),
siteSafeExpiry: timestamp('site_safe_expiry', { withTimezone: true }),

// In projects table:
siteManagerPhone: text('site_manager_phone'),
clientDemands: jsonb('client_demands'),

// In clients table:
accountManager: text('account_manager'),
notes: jsonb('notes'),
```

### Success Criteria:
#### Automated:
- [ ] `npx drizzle-kit push` runs without conflict.
#### Manual:
- [ ] Verify new columns exist in Supabase Dashboard.

## Phase 2: Core Entity API Implementation
### Overview
Create structured API routes for Candidates, Projects, and Clients that query Supabase.

### Changes Required:
#### 1. `app/api/candidates/route.js`
**Changes**: Implement GET handler using `db.select().from(candidates)`.
#### 2. `app/api/projects/route.js`
**Changes**: Implement GET handler using `db.select().from(projects)`.
#### 3. `app/api/clients/route.js`
**Changes**: Implement GET handler using `db.select().from(clients)`.

### Success Criteria:
#### Manual:
- [ ] Visit `/api/candidates` and verify JSON response contains the new schema fields.

## Phase 3: DataContext Rewiring
### Overview
Switch `DataContext` to fetch from the new API routes and remove legacy sheet/mock logic.

### Changes Required:
#### 1. `context/data-context.js`
**Changes**: 
- Replace `syncFromSheets` logic with a unified `syncFromSupabase` function.
- Fetch from `/api/candidates`, `/api/projects`, and `/api/clients`.
- Update state setters to use the new structured results.
- **DELETION**: Remove the `enrich...` functions if the API/DB now handles the structuring.
- **DELETION**: Remove all mock data imports and initial state constants.

### Success Criteria:
#### Automated:
- [ ] `npm run build` passes.
#### Manual:
- [ ] Open the Command Centre dashboard. Verify that data loads and no "mock data flicker" occurs.

**Implementation Note**: This plan assumes that a one-time migration of data from Google Sheets to Supabase has been performed or is being handled separately.
