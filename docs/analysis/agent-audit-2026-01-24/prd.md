# Supabase Data Flow & Agent Architecture PRD

## HR Eng

| Supabase Data Flow & Agent Architecture PRD |  | [Summary: This document maps the hybrid data architecture and the agent-driven Command Centre, outlining the transition to a unified Supabase backend.] |
| :---- | :---- | :---- |
| **Author**: Pickle Rick **Contributors**: Joe **Intended audience**: Engineering | **Status**: Draft **Created**: 2026-01-24 | **Self Link**: [Session Root]/prd.md **Context**: Transition to Supabase & Agent Orchestration |

## Introduction

The Stellar Co-Pilot is evolving from a prototype into a production "recruitment operating system." This requires transitioning core entity storage from Google Sheets to Supabase and formalizing the agent-based orchestration that powers the Command Centre.

## Problem Statement

**Current Process:** 
- Core entities (Candidates, Clients, Projects) are still synced from Google Sheets via `/api/sync`.
- The Command Centre UI interacts with a "Stellar GM" agent via `/api/agent`.
- Specialized intelligence (e.g., Tender Scout) is generated by specialized endpoints like `/api/scout`.

**Primary Users:** Recruiters and AI Agents.
**Pain Points:** 
- **Data Schism**: The agents in `/api/agent` fetch live context from Supabase (Internal Roster, Latest Projects), but the main dashboard (`DataContext`) is still tied to Sheets.
- **Blueprint Fragmentation**: Agent personas are defined in YAML files (`_bmad-output/bmb-creations/`), but the execution logic is currently hardcoded in API routes.

## Objective & Scope

**Objective:** Map all data and agent flows to ensure the "Stellar GM" and his specialists are consuming the same source of truth as the UI dashboard.

### In-scope or Goals
- Audit the mapping between Google Sheets columns and Supabase schema fields.
- Map the "Command Centre Orchestration Flow" (UI -> `/api/agent` -> Persona YAMLs -> Supabase Context).
- Document how specialized agents like the "Tender Scout" (`/api/scout`) integrate into the GM's strategic briefing.
- Define the transition for `DataContext` to fetch directly from Supabase-backed API routes.

## Command Centre & Agent Architecture

### 1. The Orchestrator (`/api/agent`)
The "Stellar GM" acts as the central brain. In every request, it:
- **Aggressively Fetches Context**: Queries Supabase for the internal roster and latest projects.
- **Loads Personas**: Reads `.agent.yaml` files from `_bmad-output/bmb-creations/` to define the behaviors of "The Board" (Accountant, Sales, Candidate Mgr, etc.).
- **Executes DEFCON Logic**: Calculates strategic mode based on financial variance.

### 2. Specialized Agents (The "Scout")
Specialized endpoints like `/api/scout` use the `lib/intel-engine.js` to perform deep scans of the database (e.g., finding "Tendering" packages) and return actionable "Intel Products" (SARs) to the GM.

### 3. The UI (`app/command-centre`)
The front-end acts as a "Tactical Stream," displaying real-time telemetry from Jarvis and allowing directives to be issued to the GM.

## Product Requirements

### Critical User Journeys (CUJs)
1. **The Unified Dashboard**: A recruiter opens the Command Centre. The system fetches real-time data from Supabase. The `DataContext` hydrates without mock-data flicker.
2. **Agent Observation**: The "Stellar GM" identifies a revenue risk. It consults the "Sales Lead" persona (from BMB YAML) and the live "Tender Scout" data to recommend a specific outreach strategy.

### Functional Requirements

| Priority | Requirement | User Story |
| :---- | :---- | :---- |
| P0 | **Agent Flow Map** | As a developer, I need to see how the GM orchestrates the specialized personas from BMB creations. |
| P0 | **Unified Source of Truth** | As a developer, I want the UI and the Agents to use the same Supabase data to avoid "Context Blackouts." |
| P1 | **YAML-Driven Personas** | As a developer, I want the agents to be fully controlled by the YAML definitions in `_bmad-output/bmb-creations/`. |

## Assumptions

- The Supabase schema in `lib/db/schema.ts` is the target "Source of Truth."
- Existing agent YAMLs in `bmb-creations` are the authoritative persona definitions.

## Business Benefits/Impact/Metrics

**Success Metrics:**
- 0% mismatch between UI data and Agent-reported data.
- 100% of agent personas loaded dynamically from BMB YAMLs.
- 100% coverage of core entities in Supabase.
