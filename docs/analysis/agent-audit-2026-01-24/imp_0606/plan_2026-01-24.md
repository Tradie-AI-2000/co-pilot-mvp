# Unified Agent Orchestration Implementation Plan

## Overview
This plan refactors the `app/api/agent/route.js` to transition from a hardcoded "General Manager" respondent to a dynamic, YAML-driven orchestrator. It ensures that the "Stellar GM" can assume any persona from the `_bmad-output/bmb-creations/` folder based on user selection, integrates the "Tender Scout" intelligence into the tactical stream, and wires the UI to reflect real-time agent status updates.

## Current State Analysis
- **API (`app/api/agent/route.js`)**: Hardcodes the GM persona. Loads YAMLs but doesn't use them to switch the "respondent."
- **Intel (`lib/intel-engine.js`)**: The `generateScoutIntel` function is isolated and only accessible via `/api/scout`.
- **UI (`app/command-centre/page.js`)**: Displays agents with hardcoded statuses. Ignores the `signal_updates` returned by the API.

## Implementation Approach
The strategy is to "formalize the swarm." We will make the `/api/agent` endpoint a true proxy for the agent personas. The GM will remain the "host," but the specific advice will be driven by the YAML specifications. We will also introduce a "Tactical Intel" injection point where the Scout's findings are pre-loaded into the GM's context.

## Phase 1: Backend Dynamic Persona Refactor
### Overview
Enable the API to load a specific persona as the primary respondent and inject relevant specialized intel.

### Changes Required:
#### 1. `app/api/agent/route.js`
**Changes**: 
- Update the handler to accept an `agentId` from the request body.
- Implement a helper to select the "Primary Persona" from the `AGENTS` map based on `agentId`.
- Call `generateScoutIntel()` from `lib/intel-engine.js` and inject the results into the system prompt.
- Refactor the `systemPrompt` to use the primary persona's principles and instructions.

#### 2. `lib/intel-engine.js`
**Changes**: 
- Ensure `generateScoutIntel` is exported and ready for consumption by the main agent route.

### Success Criteria:
#### Automated:
- [ ] Ensure `npm run build` passes (no broken imports).
#### Manual:
- [ ] issue a POST to `/api/agent` with `agentId: 'scout'` and verify the response reflects the "Tender Scout" persona and findings.

## Phase 2: UI State Synchronization
### Overview
Wire the Command Centre UI to actually reflect the statuses and metadata sent back by the agents.

### Changes Required:
#### 1. `app/command-centre/page.js`
**Changes**: 
- Add a `useState` hook for `specialistStates` initialized from the `specialists` constant.
- Update `handleSendMessage` to process the `signal_updates` array from the API response.
- Map over `specialistStates` in the sidebar render to display live telemetry.

### Success Criteria:
#### Manual:
- [ ] Send a message in the Command Centre. 
- [ ] Observe one of the agent cards in the sidebar change status (e.g., from 'neutral' to 'urgent') based on the API response.

## Phase 3: YAML Instruction Formalization
### Overview
Ensure the "Stellar GM" is strictly following the "Critical Actions" defined in the YAMLs.

### Changes Required:
#### 1. `app/api/agent/route.js`
**Changes**: 
- Update the system prompt to explicitly include the `critical_actions` and `menu` items from the YAMLs as valid directives the agent can "recommend."

### Success Criteria:
#### Manual:
- [ ] Ask the GM "What are your critical actions?" and verify it lists the actions from the `stellar-jarvis.agent.yaml`.

**Implementation Note**: This plan focuses on connectivity and orchestration. It assumes the underlying data in Supabase is populated and accurate.
